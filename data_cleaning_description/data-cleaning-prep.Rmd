---
title: "R Notebook"
output: github_document
---

This file contains the code we used to obtain and clean the data.

```{r}
library(RAQSAPI)
library(tidyverse)
library(stringr)
library(sjmisc)
library(keyring)
library(reprex)
library(con2aqi)
library(stringr)
library(matrixStats)

# Please follow instructions in data README to set up a RAQSAPI account so that you are able to run this line of code with YOUR email and key
# RAQSAPI::aqs_credentials("email", "key")

# Loading my own necessary information using the function keyring
datamartAPI_user <- "cweis22@uchicago.edu"
server <- "AQSDatamart"

key <- key_get(service = server, username = datamartAPI_user)

aqs_credentials(username = datamartAPI_user, key)

# To read RAQSAPI documentation
# RShowDoc(what="RAQSAPIvignette", type="html", package="RAQSAPI")
```


```{r}
# Loading California state data
# Data for California from 2011 to 2021 - only year matters in bdate/edate variables
CA1 <- aqs_annualsummary_by_state(parameter = c("88502", "42101", "42602", "44201", "81102", "88101", "42401"), bdate = as.Date("20110101", format = "%Y%m%d"), edate = as.Date("20210101", format = "%Y%m%d"), "06")

CA1_splice <- CA1 |>
  # Select necessary columns
  select(c(year,state_code,latitude,longitude,parameter,arithmetic_mean,state,
           pollutant_standard,units_of_measure,county_code,county)) |>
  # Add a row number variable to avoid list_col error with pivot_wider, which arises due
  # to repeat values
  mutate(row = row_number()) |>
  # filter to only include certain puollutant measurements
  filter(pollutant_standard %in% c("PM25 24-hour 1997", "CO 1-hour 1971", 
                                   "Ozone 1-hour 1979", "NO2 1-hour 2010", 
                                   "SO2 24-hour 1971", "PM10 24-hour 2006")) |>
  # remove pollutant_standard column to avoid pivoting issues
  select(!pollutant_standard) |>
  # pivot to calculate pollutant-wise means
  pivot_wider(names_from = parameter, values_from = arithmetic_mean) |>
  rename(PM2.5 = "PM2.5 - Local Conditions", CO = "Carbon monoxide", 
         NO2 = "Nitrogen dioxide (NO2)", SO2 = "Sulfur dioxide", 
         PM10 = "PM10 Total 0-10um STP") |>
  # re-orient row numbers
  select(!row) |>
  mutate(row = row_number()) |>
  # transform PM10 column to get it into standard units for calculating AQI index
  mutate(PM10 = PM10 * 0.6)

# round to get values at the standards necessary for AQI calculations
CA1_avg <- CA1_splice |>
  mutate(Ozone_rd = round(CA1_splice$Ozone, 3), PM2.5_rd = round(CA1_splice$PM2.5, 1),
         CO_rd = round(CA1_splice$CO, 1), NO2_rd = round(CA1_splice$NO2, 0),
         SO2_rd = round(CA1_splice$SO2, 0), PM10_rd = round(CA1_splice$PM10, 0)) |>
  # replace NAs with 0s in order to calculate AQI indices below
  mutate_all(~replace(., is.na(.), 0))

# Create tibble of AQI indices for each pollutant; each will have the same number of 
# rows thanks to 0 placeholders
# rename the one column in each tibble to a more reasonable name
Ozone_index <- tibble(con2aqi("o3", con = CA1_avg$Ozone_rd, type = "1h")) |>
  mutate(row = row_number()) |>
  rename(Ozone_index = `con2aqi("o3", con = CA1_avg$Ozone_rd, type = "1h")`)
PM2.5_index <- tibble(con2aqi("pm25", con = CA1_avg$PM2.5_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM2.5_index = `con2aqi("pm25", con = CA1_avg$PM2.5_rd, type = NULL)`)
CO_index <- tibble(con2aqi("co", con = CA1_avg$CO_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(CO_index = `con2aqi("co", con = CA1_avg$CO_rd, type = NULL)`)
NO2_index <- tibble(con2aqi("no2", con = CA1_avg$NO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(NO2_index_index = `con2aqi("no2", con = CA1_avg$NO2_rd, type = NULL)`)
SO2_index <- tibble(con2aqi("so2", con = CA1_avg$SO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(SO2_index = `con2aqi("so2", con = CA1_avg$SO2_rd, type = NULL)`)
PM10_index <- tibble(con2aqi("pm10", con = CA1_avg$PM10_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM10_index = `con2aqi("pm10", con = CA1_avg$PM10_rd, type = NULL)`)

# add index columns to previous dataset
CA1_avg2 <- merge(CA1_avg,c(Ozone_index,PM2.5_index,CO_index,NO2_index,SO2_index,PM10_index), by = "row") |>
  # remove repeat row columns
  select(!c(row.1,row.2,row.3,row.4,row.5)) |>
  group_by(year,county)

# Repeat above code for the years 2001 to 2011
# Almost all code is exactly the same, with a few variations due to different 
# availability of pollutant data
CA2 <- aqs_annualsummary_by_state(parameter = c("88502", "42101", "42602", "44201", "81102", "88101", "42401"), bdate = as.Date("20010101", format = "%Y%m%d"), edate = as.Date("20100101", format = "%Y%m%d"), "06")

CA2_splice <- CA2 |>
  select(c(year,state_code,latitude,longitude,parameter,arithmetic_mean,state,
           pollutant_standard,units_of_measure,county_code,county)) |>
  mutate(row = row_number()) |>
  filter(pollutant_standard %in% c("PM25 24-hour 1997", "CO 1-hour 1971", 
                                   "Ozone 1-hour 1979", "NO2 1-hour 2010", 
                                   "SO2 24-hour 1971", "PM10 24-hour 2006")) |>
  select(!pollutant_standard) |>
  pivot_wider(names_from = parameter, values_from = arithmetic_mean) |>
  rename(PM2.5 = "PM2.5 - Local Conditions", CO = "Carbon monoxide", 
         NO2 = "Nitrogen dioxide (NO2)", SO2 = "Sulfur dioxide", 
         PM10 = "PM10 Total 0-10um STP") |>
  select(!row) |>
  mutate(row = row_number()) |>
  mutate(PM10 = PM10 * 0.6)

CA2_avg <- CA2_splice |>
  mutate(Ozone_rd = round(CA2_splice$Ozone, 3), PM2.5_rd = round(CA2_splice$PM2.5, 1),
         CO_rd = round(CA2_splice$CO, 1), NO2_rd = round(CA2_splice$NO2, 0),
         SO2_rd = round(CA2_splice$SO2, 0), PM10_rd = round(CA2_splice$PM10, 0)) |>
  mutate_all(~replace(., is.na(.), 0))

Ozone_index <- tibble(con2aqi("o3", con = CA2_avg$Ozone_rd, type = "1h")) |>
  mutate(row = row_number()) |>
  rename(Ozone_index = `con2aqi("o3", con = CA2_avg$Ozone_rd, type = "1h")`)
PM2.5_index <- tibble(con2aqi("pm25", con = CA2_avg$PM2.5_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM2.5_index = `con2aqi("pm25", con = CA2_avg$PM2.5_rd, type = NULL)`)
CO_index <- tibble(con2aqi("co", con = CA2_avg$CO_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(CO_index = `con2aqi("co", con = CA2_avg$CO_rd, type = NULL)`)
NO2_index <- tibble(con2aqi("no2", con = CA2_avg$NO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(NO2_index_index = `con2aqi("no2", con = CA2_avg$NO2_rd, type = NULL)`)
SO2_index <- tibble(con2aqi("so2", con = CA2_avg$SO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(SO2_index = `con2aqi("so2", con = CA2_avg$SO2_rd, type = NULL)`)
PM10_index <- tibble(con2aqi("pm10", con = CA2_avg$PM10_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM10_index = `con2aqi("pm10", con = CA2_avg$PM10_rd, type = NULL)`)

CA2_avg2 <- merge(CA2_avg,c(Ozone_index,PM2.5_index,CO_index,NO2_index,SO2_index,PM10_index), by = "row") |>
  select(!c(row.1,row.2,row.3,row.4,row.5)) |>
  group_by(year,county) 

# Repeat above code for the years 1991 to 2001
# Almost all code is exactly the same, with a few variations due to different 
# availability of pollutant data
CA3 <- aqs_annualsummary_by_state(parameter = c("88502", "42101", "42602", "44201", "81102", "88101", "42401"), bdate = as.Date("19910101", format = "%Y%m%d"), edate = as.Date("20000101", format = "%Y%m%d"), "06")

CA3_splice <- CA3 |>
  select(c(year,state_code,latitude,longitude,parameter,arithmetic_mean,state,
           pollutant_standard,units_of_measure,county_code,county)) |>
  mutate(row = row_number()) |>
  filter(pollutant_standard %in% c("PM25 24-hour 1997", "CO 1-hour 1971", 
                                   "Ozone 1-hour 1979", "NO2 1-hour 2010", 
                                   "SO2 24-hour 1971", "PM10 24-hour 2006")) |>
  select(!pollutant_standard) |>
  pivot_wider(names_from = parameter, values_from = arithmetic_mean) |>
  rename(PM2.5 = "PM2.5 - Local Conditions", CO = "Carbon monoxide", 
         NO2 = "Nitrogen dioxide (NO2)", SO2 = "Sulfur dioxide", 
         PM10 = "PM10 Total 0-10um STP") |>
  select(!row) |>
  mutate(row = row_number()) |>
  mutate(PM10 = PM10 * 0.6)

CA3_avg <- CA3_splice |>
  mutate(Ozone_rd = round(CA3_splice$Ozone, 3), PM2.5_rd = round(CA3_splice$PM2.5, 1),
         CO_rd = round(CA3_splice$CO, 1), NO2_rd = round(CA3_splice$NO2, 0),
         SO2_rd = round(CA3_splice$SO2, 0), PM10_rd = round(CA3_splice$PM10, 0)) |>
  mutate_all(~replace(., is.na(.), 0))

Ozone_index <- tibble(con2aqi("o3", con = CA3_avg$Ozone_rd, type = "1h")) |>
  mutate(row = row_number()) |>
  rename(Ozone_index = `con2aqi("o3", con = CA3_avg$Ozone_rd, type = "1h")`)
PM2.5_index <- tibble(con2aqi("pm25", con = CA3_avg$PM2.5_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM2.5_index = `con2aqi("pm25", con = CA3_avg$PM2.5_rd, type = NULL)`)
CO_index <- tibble(con2aqi("co", con = CA3_avg$CO_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(CO_index = `con2aqi("co", con = CA3_avg$CO_rd, type = NULL)`)
NO2_index <- tibble(con2aqi("no2", con = CA3_avg$NO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(NO2_index_index = `con2aqi("no2", con = CA3_avg$NO2_rd, type = NULL)`)
SO2_index <- tibble(con2aqi("so2", con = CA3_avg$SO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(SO2_index = `con2aqi("so2", con = CA3_avg$SO2_rd, type = NULL)`)
PM10_index <- tibble(con2aqi("pm10", con = CA3_avg$PM10_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM10_index = `con2aqi("pm10", con = CA3_avg$PM10_rd, type = NULL)`)

CA3_avg2 <- merge(CA3_avg,c(Ozone_index,PM2.5_index,CO_index,NO2_index,SO2_index,PM10_index), by = "row") |>
  select(!c(row.1,row.2,row.3,row.4,row.5)) |>
  group_by(year,county) 

# Repeat above code for the years 1981 to 1991
# Almost all code is exactly the same, with a few variations due to different 
# availability of pollutant data
CA4 <- aqs_quarterlysummary_by_state(parameter = c("88502", "42101", "42602", "44201", "81102", "88101", "42401"), bdate = as.Date("19810101", format = "%Y%m%d"), edate = as.Date("19900101", format = "%Y%m%d"), "06")

CA4_splice <- CA4 |>
  select(c(year,state_code,latitude,longitude,parameter,arithmetic_mean,state,
           pollutant_standard,units_of_measure,county_code,county)) |>
  mutate(row = row_number()) |>
  filter(pollutant_standard %in% c("CO 1-hour 1971", 
                                   "Ozone 1-hour 1979", "NO2 1-hour 2010", 
                                   "SO2 24-hour 1971", "PM10 24-hour 2006")) |>
  select(!pollutant_standard) |>
  pivot_wider(names_from = parameter, values_from = arithmetic_mean) |>
  rename(CO = "Carbon monoxide", 
         NO2 = "Nitrogen dioxide (NO2)", SO2 = "Sulfur dioxide", 
         PM10 = "PM10 Total 0-10um STP") |>
  select(!row) |>
  mutate(row = row_number()) |>
  mutate(PM10 = PM10 * 0.6)

CA4_avg <- CA4_splice |>
  mutate(Ozone_rd = round(CA4_splice$Ozone, 3),
         CO_rd = round(CA4_splice$CO, 1), NO2_rd = round(CA4_splice$NO2, 0),
         SO2_rd = round(CA4_splice$SO2, 0), PM10_rd = round(CA4_splice$PM10, 0)) |>
  mutate_all(~replace(., is.na(.), 0))

Ozone_index <- tibble(con2aqi("o3", con = CA4_avg$Ozone_rd, type = "1h")) |>
  mutate(row = row_number()) |>
  rename(Ozone_index = `con2aqi("o3", con = CA4_avg$Ozone_rd, type = "1h")`)
CO_index <- tibble(con2aqi("co", con = CA4_avg$CO_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(CO_index = `con2aqi("co", con = CA4_avg$CO_rd, type = NULL)`)
NO2_index <- tibble(con2aqi("no2", con = CA4_avg$NO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(NO2_index_index = `con2aqi("no2", con = CA4_avg$NO2_rd, type = NULL)`)
SO2_index <- tibble(con2aqi("so2", con = CA4_avg$SO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(SO2_index = `con2aqi("so2", con = CA4_avg$SO2_rd, type = NULL)`)
PM10_index <- tibble(con2aqi("pm10", con = CA4_avg$PM10_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM10_index = `con2aqi("pm10", con = CA4_avg$PM10_rd, type = NULL)`)

CA4_avg2 <- merge(CA4_avg,c(Ozone_index,CO_index,NO2_index,SO2_index,PM10_index), by = "row") |>
  select(!c(row.1,row.2,row.3,row.4)) |>
  group_by(year,county)

# Repeat above code for the years 1971 to 1981
# Almost all code is exactly the same, with a few variations due to different 
# availability of pollutant data
CA5 <- aqs_annualsummary_by_state(parameter = c("88502", "42101", "42602", "44201", "81102", "88101", "42401"), bdate = as.Date("19710101", format = "%Y%m%d"), edate = as.Date("19800101", format = "%Y%m%d"), "06")

CA5_splice <- CA5 |>
  select(c(year,state_code,latitude,longitude,parameter,arithmetic_mean,state,
           pollutant_standard,units_of_measure,county_code,county)) |>
  mutate(row = row_number()) |>
  filter(pollutant_standard %in% c("CO 1-hour 1971", "Ozone 1-hour 1979", 
                                   "NO2 1-hour 2010", "SO2 24-hour 1971")) |>
  select(!pollutant_standard) |>
  pivot_wider(names_from = parameter, values_from = arithmetic_mean) |>
  rename(CO = "Carbon monoxide", NO2 = "Nitrogen dioxide (NO2)", 
         SO2 = "Sulfur dioxide") |>
  select(!row) |>
  mutate(row = row_number())

CA5_avg <- CA5_splice |>
  mutate(Ozone_rd = round(CA5_splice$Ozone, 3), CO_rd = round(CA5_splice$CO, 1), 
         NO2_rd = round(CA5_splice$NO2, 0), SO2_rd = round(CA5_splice$SO2, 0)) |>
  mutate_all(~replace(., is.na(.), 0))

Ozone_index <- tibble(con2aqi("o3", con = CA5_avg$Ozone_rd, type = "1h")) |>
  mutate(row = row_number()) |>
  rename(Ozone_index = `con2aqi("o3", con = CA5_avg$Ozone_rd, type = "1h")`)
CO_index <- tibble(con2aqi("co", con = CA5_avg$CO_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(CO_index = `con2aqi("co", con = CA5_avg$CO_rd, type = NULL)`)
NO2_index <- tibble(con2aqi("no2", con = CA5_avg$NO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(NO2_index_index = `con2aqi("no2", con = CA5_avg$NO2_rd, type = NULL)`)
SO2_index <- tibble(con2aqi("so2", con = CA5_avg$SO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(SO2_index = `con2aqi("so2", con = CA5_avg$SO2_rd, type = NULL)`)

CA5_avg2 <- merge(CA5_avg,c(Ozone_index,CO_index,NO2_index,SO2_index), by = "row") |>
  select(!c(row.1,row.2,row.3)) |>
  mutate(Ozone_index = 0,PM2.5_index = 0,PM10_index = 0) |>
  group_by(year,county)

# This is where we start to work with data from all years
# First, we rbind all datasets together to form one large dataset for all years
CA_overall <- rbind(CA1_avg2,CA2_avg2,CA3_avg2,CA4_avg2,CA5_avg2) |>
  rename(NO2_index = NO2_index_index)

# Pivot longer to ease with graphingâ€”this way we can filter by pollutant
CA_overall2 <- CA_overall |>
  pivot_longer(c(Ozone,NO2,PM2.5,PM10,CO,SO2), names_to = "pollutant", values_to = "arithmetic_mean") |>
  # get rid of placeholder columns
  filter(arithmetic_mean > 0)

# Create separate dataframe with only index columns
CA_indices <- tibble(CA_overall2$Ozone_index, CA_overall2$PM2.5_index,
                     CA_overall2$CO_index, CA_overall2$NO2_index, 
                     CA_overall2$SO2_index, CA_overall2$PM10_index)

# Collapse dataset horizontally by just taking the max from every row,
# thereby ignoring all 0 placeholder values
CA_indices2 <- CA_indices |>
  mutate(AQI = rowMaxs(as.matrix(CA_indices))) |>
  # Only keep the new collapsed column
  select(AQI)

# Add collapsed column to original dataset
CA_overall2 <- CA_overall2 |>
  cbind(CA_indices2)

# Now, calculate the actual AQI for each county and each year by taking the AQI index
# with the highest value in the grouped dataset
CA_overall3 <- CA_overall2 |>
  group_by(year, state, county, county_code, state_code) |>
  summarise(AQI = max(AQI))

# Since some counties have more than 1 air pollutant monitoring station, take
# the mean of each pollutant in each ocunty for each year
CA_overall4 <- CA_overall2 |>
  group_by(year, state, county, county_code, state_code, pollutant) |>
  summarise(arithmetic_mean = mean(arithmetic_mean))

# Join the dataset with AQI values and the dataset with mean arithmetic means
# Use full_join since the AQI values dataset is shorter, since it takes the max over
# each pollutant for each county and year
CA_overall5 <- full_join(CA_overall3, CA_overall4, 
                         by = c("year", "state", "county", "county_code", 
                                "state_code"))

# Make CSV file of final dataset
write_csv(CA_overall5, "CA_overall5.csv")
```

```{r}
# Loading California state data
# Data for California from 2011 to 2021 - only year matters in bdate/edate variables
CA1 <- aqs_annualsummary_by_state(parameter = c("88502", "42101", "42602", "44201", "81102", "88101", "42401"), bdate = as.Date("20110101", format = "%Y%m%d"), edate = as.Date("20210101", format = "%Y%m%d"), "06")

CA1_splice <- CA1 |>
  # Select necessary columns
  select(c(year,state_code,latitude,longitude,parameter,arithmetic_mean,state,
           pollutant_standard,units_of_measure,county_code,county)) |>
  # Add a row number variable to avoid list_col error with pivot_wider, which arises due
  # to repeat values
  mutate(row = row_number()) |>
  # filter to only include certain puollutant measurements
  filter(pollutant_standard %in% c("PM25 24-hour 1997", "CO 1-hour 1971", 
                                   "Ozone 1-hour 1979", "NO2 1-hour 2010", 
                                   "SO2 24-hour 1971", "PM10 24-hour 2006")) |>
  # remove pollutant_standard column to avoid pivoting issues
  select(!pollutant_standard) |>
  # pivot to calculate pollutant-wise means
  pivot_wider(names_from = parameter, values_from = arithmetic_mean) |>
  rename(PM2.5 = "PM2.5 - Local Conditions", CO = "Carbon monoxide", 
         NO2 = "Nitrogen dioxide (NO2)", SO2 = "Sulfur dioxide", 
         PM10 = "PM10 Total 0-10um STP") |>
  # re-orient row numbers
  select(!row) |>
  mutate(row = row_number()) |>
  # transform PM10 column to get it into standard units for calculating AQI index
  mutate(PM10 = PM10 * 0.6)

# round to get values at the standards necessary for AQI calculations
CA1_avg <- CA1_splice |>
  mutate(Ozone_rd = round(CA1_splice$Ozone, 3), PM2.5_rd = round(CA1_splice$PM2.5, 1),
         CO_rd = round(CA1_splice$CO, 1), NO2_rd = round(CA1_splice$NO2, 0),
         SO2_rd = round(CA1_splice$SO2, 0), PM10_rd = round(CA1_splice$PM10, 0)) |>
  # replace NAs with 0s in order to calculate AQI indices below
  mutate_all(~replace(., is.na(.), 0))

# Create tibble of AQI indices for each pollutant; each will have the same number of 
# rows thanks to 0 placeholders
# rename the one column in each tibble to a more reasonable name
Ozone_index <- tibble(con2aqi("o3", con = CA1_avg$Ozone_rd, type = "1h")) |>
  mutate(row = row_number()) |>
  rename(Ozone_index = `con2aqi("o3", con = CA1_avg$Ozone_rd, type = "1h")`)
PM2.5_index <- tibble(con2aqi("pm25", con = CA1_avg$PM2.5_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM2.5_index = `con2aqi("pm25", con = CA1_avg$PM2.5_rd, type = NULL)`)
CO_index <- tibble(con2aqi("co", con = CA1_avg$CO_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(CO_index = `con2aqi("co", con = CA1_avg$CO_rd, type = NULL)`)
NO2_index <- tibble(con2aqi("no2", con = CA1_avg$NO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(NO2_index_index = `con2aqi("no2", con = CA1_avg$NO2_rd, type = NULL)`)
SO2_index <- tibble(con2aqi("so2", con = CA1_avg$SO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(SO2_index = `con2aqi("so2", con = CA1_avg$SO2_rd, type = NULL)`)
PM10_index <- tibble(con2aqi("pm10", con = CA1_avg$PM10_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM10_index = `con2aqi("pm10", con = CA1_avg$PM10_rd, type = NULL)`)

# add index columns to previous dataset
CA1_avg2 <- merge(CA1_avg,c(Ozone_index,PM2.5_index,CO_index,NO2_index,SO2_index,PM10_index), by = "row") |>
  # remove repeat row columns
  select(!c(row.1,row.2,row.3,row.4,row.5)) |>
  group_by(year,county)

# Repeat above code for the years 2001 to 2011
# Almost all code is exactly the same, with a few variations due to different 
# availability of pollutant data
CA2 <- aqs_annualsummary_by_state(parameter = c("88502", "42101", "42602", "44201", "81102", "88101", "42401"), bdate = as.Date("20010101", format = "%Y%m%d"), edate = as.Date("20100101", format = "%Y%m%d"), "06")

CA2_splice <- CA2 |>
  select(c(year,state_code,latitude,longitude,parameter,arithmetic_mean,state,
           pollutant_standard,units_of_measure,county_code,county)) |>
  mutate(row = row_number()) |>
  filter(pollutant_standard %in% c("PM25 24-hour 1997", "CO 1-hour 1971", 
                                   "Ozone 1-hour 1979", "NO2 1-hour 2010", 
                                   "SO2 24-hour 1971", "PM10 24-hour 2006")) |>
  select(!pollutant_standard) |>
  pivot_wider(names_from = parameter, values_from = arithmetic_mean) |>
  rename(PM2.5 = "PM2.5 - Local Conditions", CO = "Carbon monoxide", 
         NO2 = "Nitrogen dioxide (NO2)", SO2 = "Sulfur dioxide", 
         PM10 = "PM10 Total 0-10um STP") |>
  select(!row) |>
  mutate(row = row_number()) |>
  mutate(PM10 = PM10 * 0.6)

CA2_avg <- CA2_splice |>
  mutate(Ozone_rd = round(CA2_splice$Ozone, 3), PM2.5_rd = round(CA2_splice$PM2.5, 1),
         CO_rd = round(CA2_splice$CO, 1), NO2_rd = round(CA2_splice$NO2, 0),
         SO2_rd = round(CA2_splice$SO2, 0), PM10_rd = round(CA2_splice$PM10, 0)) |>
  mutate_all(~replace(., is.na(.), 0))

Ozone_index <- tibble(con2aqi("o3", con = CA2_avg$Ozone_rd, type = "1h")) |>
  mutate(row = row_number()) |>
  rename(Ozone_index = `con2aqi("o3", con = CA2_avg$Ozone_rd, type = "1h")`)
PM2.5_index <- tibble(con2aqi("pm25", con = CA2_avg$PM2.5_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM2.5_index = `con2aqi("pm25", con = CA2_avg$PM2.5_rd, type = NULL)`)
CO_index <- tibble(con2aqi("co", con = CA2_avg$CO_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(CO_index = `con2aqi("co", con = CA2_avg$CO_rd, type = NULL)`)
NO2_index <- tibble(con2aqi("no2", con = CA2_avg$NO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(NO2_index_index = `con2aqi("no2", con = CA2_avg$NO2_rd, type = NULL)`)
SO2_index <- tibble(con2aqi("so2", con = CA2_avg$SO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(SO2_index = `con2aqi("so2", con = CA2_avg$SO2_rd, type = NULL)`)
PM10_index <- tibble(con2aqi("pm10", con = CA2_avg$PM10_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM10_index = `con2aqi("pm10", con = CA2_avg$PM10_rd, type = NULL)`)

CA2_avg2 <- merge(CA2_avg,c(Ozone_index,PM2.5_index,CO_index,NO2_index,SO2_index,PM10_index), by = "row") |>
  select(!c(row.1,row.2,row.3,row.4,row.5)) |>
  group_by(year,county) 

# Repeat above code for the years 1991 to 2001
# Almost all code is exactly the same, with a few variations due to different 
# availability of pollutant data
CA3 <- aqs_annualsummary_by_state(parameter = c("88502", "42101", "42602", "44201", "81102", "88101", "42401"), bdate = as.Date("19910101", format = "%Y%m%d"), edate = as.Date("20000101", format = "%Y%m%d"), "06")

CA3_splice <- CA3 |>
  select(c(year,state_code,latitude,longitude,parameter,arithmetic_mean,state,
           pollutant_standard,units_of_measure,county_code,county)) |>
  mutate(row = row_number()) |>
  filter(pollutant_standard %in% c("PM25 24-hour 1997", "CO 1-hour 1971", 
                                   "Ozone 1-hour 1979", "NO2 1-hour 2010", 
                                   "SO2 24-hour 1971", "PM10 24-hour 2006")) |>
  select(!pollutant_standard) |>
  pivot_wider(names_from = parameter, values_from = arithmetic_mean) |>
  rename(PM2.5 = "PM2.5 - Local Conditions", CO = "Carbon monoxide", 
         NO2 = "Nitrogen dioxide (NO2)", SO2 = "Sulfur dioxide", 
         PM10 = "PM10 Total 0-10um STP") |>
  select(!row) |>
  mutate(row = row_number()) |>
  mutate(PM10 = PM10 * 0.6)

CA3_avg <- CA3_splice |>
  mutate(Ozone_rd = round(CA3_splice$Ozone, 3), PM2.5_rd = round(CA3_splice$PM2.5, 1),
         CO_rd = round(CA3_splice$CO, 1), NO2_rd = round(CA3_splice$NO2, 0),
         SO2_rd = round(CA3_splice$SO2, 0), PM10_rd = round(CA3_splice$PM10, 0)) |>
  mutate_all(~replace(., is.na(.), 0))

Ozone_index <- tibble(con2aqi("o3", con = CA3_avg$Ozone_rd, type = "1h")) |>
  mutate(row = row_number()) |>
  rename(Ozone_index = `con2aqi("o3", con = CA3_avg$Ozone_rd, type = "1h")`)
PM2.5_index <- tibble(con2aqi("pm25", con = CA3_avg$PM2.5_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM2.5_index = `con2aqi("pm25", con = CA3_avg$PM2.5_rd, type = NULL)`)
CO_index <- tibble(con2aqi("co", con = CA3_avg$CO_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(CO_index = `con2aqi("co", con = CA3_avg$CO_rd, type = NULL)`)
NO2_index <- tibble(con2aqi("no2", con = CA3_avg$NO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(NO2_index_index = `con2aqi("no2", con = CA3_avg$NO2_rd, type = NULL)`)
SO2_index <- tibble(con2aqi("so2", con = CA3_avg$SO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(SO2_index = `con2aqi("so2", con = CA3_avg$SO2_rd, type = NULL)`)
PM10_index <- tibble(con2aqi("pm10", con = CA3_avg$PM10_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM10_index = `con2aqi("pm10", con = CA3_avg$PM10_rd, type = NULL)`)

CA3_avg2 <- merge(CA3_avg,c(Ozone_index,PM2.5_index,CO_index,NO2_index,SO2_index,PM10_index), by = "row") |>
  select(!c(row.1,row.2,row.3,row.4,row.5)) |>
  group_by(year,county) 

# Repeat above code for the years 1981 to 1991
# Almost all code is exactly the same, with a few variations due to different 
# availability of pollutant data
CA4 <- aqs_quarterlysummary_by_state(parameter = c("88502", "42101", "42602", "44201", "81102", "88101", "42401"), bdate = as.Date("19810101", format = "%Y%m%d"), edate = as.Date("19900101", format = "%Y%m%d"), "06")

CA4_splice <- CA4 |>
  select(c(year,state_code,latitude,longitude,parameter,arithmetic_mean,state,
           pollutant_standard,units_of_measure,county_code,county)) |>
  mutate(row = row_number()) |>
  filter(pollutant_standard %in% c("CO 1-hour 1971", 
                                   "Ozone 1-hour 1979", "NO2 1-hour 2010", 
                                   "SO2 24-hour 1971", "PM10 24-hour 2006")) |>
  select(!pollutant_standard) |>
  pivot_wider(names_from = parameter, values_from = arithmetic_mean) |>
  rename(CO = "Carbon monoxide", 
         NO2 = "Nitrogen dioxide (NO2)", SO2 = "Sulfur dioxide", 
         PM10 = "PM10 Total 0-10um STP") |>
  select(!row) |>
  mutate(row = row_number()) |>
  mutate(PM10 = PM10 * 0.6)

CA4_avg <- CA4_splice |>
  mutate(Ozone_rd = round(CA4_splice$Ozone, 3),
         CO_rd = round(CA4_splice$CO, 1), NO2_rd = round(CA4_splice$NO2, 0),
         SO2_rd = round(CA4_splice$SO2, 0), PM10_rd = round(CA4_splice$PM10, 0)) |>
  mutate_all(~replace(., is.na(.), 0))

Ozone_index <- tibble(con2aqi("o3", con = CA4_avg$Ozone_rd, type = "1h")) |>
  mutate(row = row_number()) |>
  rename(Ozone_index = `con2aqi("o3", con = CA4_avg$Ozone_rd, type = "1h")`)
CO_index <- tibble(con2aqi("co", con = CA4_avg$CO_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(CO_index = `con2aqi("co", con = CA4_avg$CO_rd, type = NULL)`)
NO2_index <- tibble(con2aqi("no2", con = CA4_avg$NO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(NO2_index_index = `con2aqi("no2", con = CA4_avg$NO2_rd, type = NULL)`)
SO2_index <- tibble(con2aqi("so2", con = CA4_avg$SO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(SO2_index = `con2aqi("so2", con = CA4_avg$SO2_rd, type = NULL)`)
PM10_index <- tibble(con2aqi("pm10", con = CA4_avg$PM10_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(PM10_index = `con2aqi("pm10", con = CA4_avg$PM10_rd, type = NULL)`)

CA4_avg2 <- merge(CA4_avg,c(Ozone_index,CO_index,NO2_index,SO2_index,PM10_index), by = "row") |>
  select(!c(row.1,row.2,row.3,row.4)) |>
  group_by(year,county)

# Repeat above code for the years 1971 to 1981
# Almost all code is exactly the same, with a few variations due to different 
# availability of pollutant data
CA5 <- aqs_annualsummary_by_state(parameter = c("88502", "42101", "42602", "44201", "81102", "88101", "42401"), bdate = as.Date("19710101", format = "%Y%m%d"), edate = as.Date("19800101", format = "%Y%m%d"), "06")

CA5_splice <- CA5 |>
  select(c(year,state_code,latitude,longitude,parameter,arithmetic_mean,state,
           pollutant_standard,units_of_measure,county_code,county)) |>
  mutate(row = row_number()) |>
  filter(pollutant_standard %in% c("CO 1-hour 1971", "Ozone 1-hour 1979", 
                                   "NO2 1-hour 2010", "SO2 24-hour 1971")) |>
  select(!pollutant_standard) |>
  pivot_wider(names_from = parameter, values_from = arithmetic_mean) |>
  rename(CO = "Carbon monoxide", NO2 = "Nitrogen dioxide (NO2)", 
         SO2 = "Sulfur dioxide") |>
  select(!row) |>
  mutate(row = row_number())

CA5_avg <- CA5_splice |>
  mutate(Ozone_rd = round(CA5_splice$Ozone, 3), CO_rd = round(CA5_splice$CO, 1), 
         NO2_rd = round(CA5_splice$NO2, 0), SO2_rd = round(CA5_splice$SO2, 0)) |>
  mutate_all(~replace(., is.na(.), 0))

Ozone_index <- tibble(con2aqi("o3", con = CA5_avg$Ozone_rd, type = "1h")) |>
  mutate(row = row_number()) |>
  rename(Ozone_index = `con2aqi("o3", con = CA5_avg$Ozone_rd, type = "1h")`)
CO_index <- tibble(con2aqi("co", con = CA5_avg$CO_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(CO_index = `con2aqi("co", con = CA5_avg$CO_rd, type = NULL)`)
NO2_index <- tibble(con2aqi("no2", con = CA5_avg$NO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(NO2_index_index = `con2aqi("no2", con = CA5_avg$NO2_rd, type = NULL)`)
SO2_index <- tibble(con2aqi("so2", con = CA5_avg$SO2_rd, type = NULL)) |>
  mutate(row = row_number()) |>
  rename(SO2_index = `con2aqi("so2", con = CA5_avg$SO2_rd, type = NULL)`)

CA5_avg2 <- merge(CA5_avg,c(Ozone_index,CO_index,NO2_index,SO2_index), by = "row") |>
  select(!c(row.1,row.2,row.3)) |>
  mutate(Ozone_index = 0,PM2.5_index = 0,PM10_index = 0) |>
  group_by(year,county)
```

